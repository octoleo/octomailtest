#!/usr/bin/env bash
set -euo pipefail

#############################################
# Defaults (LOWEST priority)
#############################################

DOMAIN=""
HOST=""
EMAIL=""
PASS=""

IMAP_PORT=993
SMTP_PORT=587
SIEVE_PORT=4190

CONFIG_FILE="./.octomailtest"

#############################################
# Logging helpers
#############################################

ts() { date +"%Y-%m-%d %H:%M:%S"; }

log() { echo "[$(ts)] $*"; }

warn() { echo "[$(ts)] ‚ö†Ô∏è  $*" >&2; }

err() { echo "[$(ts)] ‚ùå $*" >&2; }

die() { err "$*"; exit 1; }

#############################################
# Failure tracking (only exit non-zero on real failures)
#############################################

FAIL_COUNT=0

fail() {
	FAIL_COUNT=$((FAIL_COUNT + 1))
	err "$*"
}

#############################################
# Command existence checks
#############################################

need_cmd() {
	command -v "$1" >/dev/null 2>&1 || die "Missing required command: $1"
}

#############################################
# OpenSSL client helpers (avoid CRLF false positives)
#
# Rule: use printf with \n + openssl -crlf
#############################################

openssl_imap() {
	# Args: payload (string with \n newlines)
	local payload="${1}"
	timeout 10 bash -c '
		printf "%s" "$1" | openssl s_client \
			-connect "'"$HOST:$IMAP_PORT"'" \
			-servername "'"$HOST"'" \
			-crlf \
			-quiet 2>/dev/null
	' _ "$payload"
}

openssl_smtp_starttls() {
	# Args: payload (string with \n newlines)
	local payload="${1}"
	timeout 10 bash -c '
		printf "%s" "$1" | openssl s_client \
			-starttls smtp \
			-connect "'"$HOST:$SMTP_PORT"'" \
			-servername "'"$HOST"'" \
			-crlf \
			-quiet 2>/dev/null
	' _ "$payload"
}

#############################################
# 1) Load config file (overrides defaults)
#############################################

if [[ -f "$CONFIG_FILE" ]]; then
	# shellcheck disable=SC1090
	source "$CONFIG_FILE"
fi

#############################################
# 2) Load environment variables (override config)
#############################################

DOMAIN="${OCTOMAILTEST_DOMAIN:-${DOMAIN:-}}"
HOST="${OCTOMAILTEST_HOST:-${HOST:-}}"
EMAIL="${OCTOMAILTEST_EMAIL:-${EMAIL:-}}"
PASS="${OCTOMAILTEST_PASS:-${PASS:-}}"

IMAP_PORT="${OCTOMAILTEST_IMAP_PORT:-${IMAP_PORT}}"
SMTP_PORT="${OCTOMAILTEST_SMTP_PORT:-${SMTP_PORT}}"
SIEVE_PORT="${OCTOMAILTEST_SIEVE_PORT:-${SIEVE_PORT}}"

#############################################
# 3) Parse command-line arguments (HIGHEST priority)
#############################################

print_help() {
	cat <<EOF
Usage: $0 [options]

Options:
  -d, --domain       Domain name
  -h, --host         Mail host
  -e, --email        Email address
  -p, --pass         Password

      --imap-port    IMAP port   (default: 993)
      --smtp-port    SMTP port   (default: 587)
      --sieve-port   Sieve port  (default: 4190)

  -c, --config       Config file (default: ./.octomailtest)
  --help             Show this help

Environment variables:
  OCTOMAILTEST_DOMAIN
  OCTOMAILTEST_HOST
  OCTOMAILTEST_EMAIL
  OCTOMAILTEST_PASS
  OCTOMAILTEST_IMAP_PORT
  OCTOMAILTEST_SMTP_PORT
  OCTOMAILTEST_SIEVE_PORT

Precedence:
  1) Command-line options
  2) Environment variables
  3) Config file
  4) Defaults
EOF
}

while [[ $# -gt 0 ]]; do
	case "$1" in
		-d|--domain)
			DOMAIN="${2:-}"; shift 2 ;;
		-h|--host)
			HOST="${2:-}"; shift 2 ;;
		-e|--email)
			EMAIL="${2:-}"; shift 2 ;;
		-p|--pass)
			PASS="${2:-}"; shift 2 ;;
		--imap-port)
			IMAP_PORT="${2:-}"; shift 2 ;;
		--smtp-port)
			SMTP_PORT="${2:-}"; shift 2 ;;
		--sieve-port)
			SIEVE_PORT="${2:-}"; shift 2 ;;
		-c|--config)
			CONFIG_FILE="${2:-}"
			shift 2
			if [[ -f "$CONFIG_FILE" ]]; then
				# shellcheck disable=SC1090
				source "$CONFIG_FILE"
			else
				die "Config file not found: $CONFIG_FILE"
			fi
			;;
		--help)
			print_help
			exit 0
			;;
		*)
			die "Unknown option: $1"
			;;
	esac
done

#############################################
# 4) Validation
#############################################

if [[ -z "$HOST" || -z "$EMAIL" || -z "$PASS" ]]; then
	err "HOST, EMAIL, and PASS must be set."
	print_help
	exit 1
fi

if [[ -z "$DOMAIN" ]]; then
	# Not fatal, but some DNS tests depend on it.
	warn "DOMAIN not set; DNS record checks will be limited."
fi

#############################################
# 5) Requirements
#############################################

need_cmd dig
need_cmd openssl
need_cmd nc
need_cmd awk
need_cmd grep
need_cmd head
need_cmd sed
need_cmd timeout
need_cmd date
need_cmd base64

if command -v swaks >/dev/null 2>&1; then
	HAS_SWAKS=1
else
	HAS_SWAKS=0
	warn "swaks not found; SMTP AUTH/send tests will be skipped."
fi

TEST_SUBJECT="SMTP_TEST_$(date +%Y%m%d_%H%M%S)"

echo "================================================="
echo " Mail Diagnostics for ${DOMAIN:-"(DOMAIN not set)"}"
echo "================================================="
echo

#############################################
# DNS: MX/SPF/DMARC/DKIM etc. (DOMAIN-based)
#############################################

if [[ -n "$DOMAIN" ]]; then
	echo "üîé MX records"
	dig +short MX "${DOMAIN}" || true
	echo

	echo "üîé SPF record"
	dig +short TXT "${DOMAIN}" | grep -i spf || warn "No SPF record found"
	echo

	echo "üîé DMARC record"
	dig +short TXT "_dmarc.${DOMAIN}" || warn "No DMARC record found"
	echo

	echo "üîé DKIM selectors (common)"
	for sel in dkim default mail; do
		echo "Selector: ${sel}"
		dig +short TXT "${sel}._domainkey.${DOMAIN}" || true
	done
	echo

	echo "üîé BIMI record (optional)"
	dig +short TXT "default._bimi.${DOMIAN}" || echo "No BIMI record found"
	echo

	echo "üîé MTA-STS policy (optional)"
	dig +short TXT "_mta-sts.${DOMAIN}" || echo "No MTA-STS record found"
	echo

	echo "üîé TLS-RPT record (optional)"
	dig _short TXT "_smtp._tls.${DOMAIN}" || echo "No TLS-RPT record found"
	echo
else
	warn "Skipping domain DNS record checks (DOMAIN not set)."
	echo
fi

#############################################
# Port reachability (HOST-based)
#############################################

echo "================================================="
echo " SMTP/IMAP/SIEVE Port Reachability (${HOST})"
echo "================================================="
PORTS=(25 465 587 "${IMAP_PORT}" "${SIEVE_PORT}")
for port in "${PORTS[@]}"; do
	echo -n "Port ${port}: "
	if nc -zv "${HOST}" "${port}" 2>&1 | grep -E "succeeded|open" >/dev/null; then
		echo "‚úÖ open"
	else
		fail "Port ${port} appears blocked/unreachable"
	fi
done
echo

#############################################
# STARTTLS / SMTPS certificate summary
#############################################

echo "================================================="
echo " STARTTLS on ${SMTP_PORT}"
echo "================================================="
if echo | openssl s_client -starttls smtp -connect "${HOST}:${SMTP_PORT}" -servername "${HOST}" 2>/dev/null \
	| openssl x509 -noout -subject -issuer -dates >/dev/null 2>&1; then
	echo | openssl s_client -starttls smtp -connect "${HOST}:${SMTP_PORT}" -servername "${HOST}" 2>/dev/null \
		| openssl x509 -noout -subject -issuer -dates
else
	fail "Unable to fetch certificate via SMTP STARTTLS on ${SMTP_PORT}"
fi
echo

echo "================================================="
echo " SMTPS on 465"
echo "================================================="
if echo | openssl s_client -connect "${HOST}:465" -servername "${HOST}" 2>/dev/null \
	| openssl x509 -noout -subject -issuer -dates >/dev/null 2>&1; then
	echo | openssl s_client -connect "${HOST}:465" -servername "${HOST}" 2>/dev/null \
		| openssl x509 -noout -subject -issuer -dates
else
	fail "Unable to fetch certificate via SMTPS on 465"
fi
echo

echo "========================================"
echo " Mail Connectivity Diagnostic"
echo " Host: $HOST"
echo " User: $EMAIL"
echo "========================================"
echo

#############################################
# DNS resolution and reverse DNS
#############################################

echo "================================================="
echo " DNS resolution (A record) for host"
echo "================================================="
IP="$(dig +short A "$HOST" | head -n1 || true)"
if [[ -n "$IP" ]]; then
	echo "$IP"
else
	fail "Could not resolve A record for host: $HOST"
fi
echo

echo "================================================="
echo " Reverse DNS check"
echo "================================================="
if [[ -n "$IP" ]]; then
	PTR="$(dig +short -x "$IP" | head -n1 || true)"
	if [[ -n "$PTR" ]]; then
		echo "‚úÖ PTR record found: $PTR"
		if [[ "${PTR%.}" == "${HOST}." || "${PTR%.}" == "${HOST}" ]]; then
			echo "‚úÖ PTR record matches hostname"
		else
			warn "PTR record does not match hostname exactly (may be OK depending on ISP setup)"
		fi
	else
		fail "No PTR record found for IP: $IP"
	fi
else
	fail "Skipping PTR check (no IP resolved)"
fi
echo

#############################################
# Basic RBL checks
#############################################

echo "================================================="
echo " Blacklist check (common RBLs)"
echo "================================================="
if [[ -n "$IP" ]]; then
	RBLS=(
		"zen.spamhaus.org"
		"bl.spamcop.net"
		"b.barracudacentral.org"
		"dnsbl.sorbs.net"
	)
	REVERSED_IP="$(echo "$IP" | awk -F. '{print $4"."$3"."$2"."$1}')"
	for rbl in "${RBLS[@]}"; do
		RESULT="$(dig +short "${REVERSED_IP}.${rbl}" 2>/dev/null | head -n1 || true)"
		if [[ -n "$RESULT" ]]; then
			fail "LISTED on ${rbl}: ${RESULT}"
		else
			echo "‚úÖ NOT listed on ${rbl}"
		fi
	done
else
	warn "Cannot check RBLs without a resolved IP"
fi
echo

#############################################
# TLS test (IMAPS)
#############################################

echo "================================================="
echo " TLS test (IMAPS)"
echo "================================================="
if openssl s_client \
	-connect "${HOST}:${IMAP_PORT}" \
	-servername "${HOST}" \
	-brief < /dev/null >/dev/null 2>&1; then
	openssl s_client \
		-connect "${HOST}:${IMAP_PORT}" \
		-servername "${HOST}" \
		-brief < /dev/null || true
else
	fail "IMAPS TLS handshake failed on ${HOST}:${IMAP_PORT}"
fi
echo

echo "================================================="
echo " TLS cipher suite test (IMAPS)"
echo "================================================="
echo "Testing cipher strength..."
CIPHER_INFO="$(echo | openssl s_client -connect "${HOST}:${IMAP_PORT}" -servername "${HOST}" 2>/dev/null | grep -E "Cipher|Protocol" || true)"
echo "${CIPHER_INFO}"
if echo "${CIPHER_INFO}" | grep -Eqi "TLSv1\.3|TLSv1\.2"; then
	echo "‚úÖ Using modern TLS protocol"
else
	fail "Using outdated TLS protocol (expected TLS 1.2+)"
fi
echo

#############################################
# IMAP protocol greeting test (FIXED - no CRLF false positives)
#############################################

echo "================================================="
echo " IMAP protocol greeting test"
echo "================================================="
IMAP_GREET="$(openssl_imap "a CAPABILITY\n" | head -20 || true)"
echo "$IMAP_GREET"
if echo "$IMAP_GREET" | grep -qE "^\* OK"; then
	echo "‚úÖ IMAP greeting received"
else
	fail "IMAP greeting test failed (no '* OK' banner received)"
fi
echo

#############################################
# IMAP CAPABILITY detailed test
#############################################

echo "================================================="
echo " IMAP CAPABILITY detailed test"
echo "================================================="
IMAP_CAP="$(openssl_imap "a001 CAPABILITY\na002 LOGOUT\n" || true)"
echo "$IMAP_CAP" | grep -E "CAPABILITY|IMAP4|IDLE|COMPRESS" | head -5 || true
if echo "$IMAP_CAP" | grep -q "CAPABILITY"; then
	echo "‚úÖ IMAP CAPABILITY retrieved successfully"
	echo "$IMAP_CAP" | grep "^\* CAPABILITY" | sed 's/^\* CAPABILITY /  Capabilities: /' || true
else
	fail "Could not retrieve IMAP capabilities"
fi
echo

#############################################
# IMAP LOGIN test (authentication only)
# NOTE: This uses plain LOGIN with raw credentials; in CI logs, treat output as sensitive.
#############################################

echo "================================================="
echo " IMAP LOGIN test (authentication only)"
echo "================================================="
IMAP_LOGIN="$(
	timeout 12 bash -c '
	(
	  sleep 1
	  printf "a001 LOGIN %s %s\n" "'"$EMAIL"'" "'"$PASS"'"
	  sleep 2
	  printf "a002 LIST \"\" \"*\"\n"
	  sleep 2
	  printf "a003 LOGOUT\n"
	) | openssl s_client \
		-connect "'"$HOST:$IMAP_PORT"'" \
		-servername "'"$HOST"'" \
		-crlf \
		-quiet 2>/dev/null
	' || true
)"
echo "$IMAP_LOGIN" | grep -E "a001|a002|LIST" | head -15 || true
if echo "$IMAP_LOGIN" | grep -qE "a001 OK"; then
	echo "‚úÖ IMAP authentication successful"
	FOLDER_COUNT="$(echo "$IMAP_LOGIN" | grep -c "^\* LIST" || true)"
	if [[ "${FOLDER_COUNT:-0}" -gt 0 ]]; then
		echo "‚úÖ Found $FOLDER_COUNT IMAP folders"
	fi
else
	fail "IMAP authentication failed or incomplete"
fi
echo

#############################################
# IMAP IDLE capability test
#############################################

echo "================================================="
echo " IMAP IDLE capability test"
echo "================================================="
IMAP_IDLE="$(
	timeout 15 bash -c '
	(
	  sleep 1
	  printf "a001 LOGIN %s %s\n" "'"$EMAIL"'" "'"$PASS"'"
	  sleep 2
	  printf "a002 SELECT INBOX\n"
	  sleep 2
	  printf "a003 IDLE\n"
	  sleep 3
	  printf "DONE\n"
	  sleep 1
	  printf "a004 LOGOUT\n"
	) | openssl s_client \
		-connect "'"$HOST:$IMAP_PORT"'" \
		-servername "'"$HOST"'" \
		-crlf \
		-quiet 2>/dev/null
	' || true
)"
echo "$IMAP_IDLE" | grep -E "IDLE|\+ idling|a003|a002 OK" | head -10 || true
if echo "$IMAP_IDLE" | grep -qE "\+ idling|a003 OK"; then
	echo "‚úÖ IDLE supported"
else
	if echo "$IMAP_CAP" | grep -q "IDLE"; then
		warn "IDLE advertised in CAPABILITY but runtime IDLE test incomplete"
	else
		warn "IDLE not advertised (optional)"
	fi
fi
echo

#############################################
# IMAP COMPRESS capability test
#############################################

echo "================================================="
echo " IMAP COMPRESS capability test"
echo "================================================="
if echo "$IMAP_CAP" | grep -qi "COMPRESS"; then
	echo "‚úÖ COMPRESS supported"
else
	echo "COMPRESS not advertised (optional feature)"
fi
echo

#############################################
# ManageSieve tests
#############################################

echo "================================================="
echo " ManageSieve port test"
echo "================================================="
echo -n "Sieve port ${SIEVE_PORT}: "
if nc -zv "${HOST}" "${SIEVE_PORT}" 2>&1 | grep -E "succeeded|open" >/dev/null; then
	echo "‚úÖ open"
else
	fail "Sieve port not accessible"
fi
echo

echo "================================================="
echo " ManageSieve CAPABILITY test"
echo "================================================="
if nc -zv "${HOST}" "${SIEVE_PORT}" 2>&1 | grep -qE "succeeded|open"; then
	SIEVE_CAP="$(
		timeout 8 bash -c '
		(
		  sleep 1
		  printf "CAPABILITY\r\n"
		  sleep 1
		  printf "LOGOUT\r\n"
		) | openssl s_client -connect "'"$HOST:$SIEVE_PORT"'" -quiet 2>/dev/null
		' || true
	)"
	echo "$SIEVE_CAP" | grep -E "SIEVE|CAPABILITY|STARTTLS" || warn "Could not get Sieve capabilities"
else
	warn "Skipping - Sieve port not accessible"
fi
echo

echo "================================================="
echo " ManageSieve authentication test"
echo "================================================="
if nc -zv "${HOST}" "${SIEVE_PORT}" 2>&1 | grep -qE "succeeded|open"; then
	AUTH_B64="$(printf '\0%s\0%s' "$EMAIL" "$PASS" | base64 | tr -d '\n')"
	SIEVE_AUTH="$(
		timeout 10 bash -c '
		(
		  sleep 1
		  printf "CAPABILITY\r\n"
		  sleep 1
		  printf "AUTHENTICATE \"PLAIN\" \"'"$AUTH_B64"'\"\r\n"
		  sleep 1
		  printf "LISTSCRIPTS\r\n"
		  sleep 1
		  printf "LOGOUT\r\n"
		) | openssl s_client -connect "'"$HOST:$SIEVE_PORT"'" -quiet 2>/dev/null
		' || true
	)"
	echo "$SIEVE_AUTH" | grep -E "OK|ACTIVE|LISTSCRIPTS" || warn "Sieve authentication test incomplete"
else
	warn "Skipping - Sieve port not accessible"
fi
echo

#############################################
# SMTP: EHLO capability capture (FIXED - avoid CRLF false positives)
#############################################

echo "================================================="
echo " SMTP STARTTLS capability"
echo "================================================="
SMTP_EHLO="$(timeout 5 swaks \
	--server "${HOST}" \
	--port "${SMTP_PORT}" \
	--tls \
	--ehlo test \
	--quit-after EHLO 2>/dev/null || true)"
echo "$SMTP_EHLO" | head -40 || true
if echo "$SMTP_EHLO" | grep -qi "250-"; then
	echo "‚úÖ SMTP EHLO succeeded over STARTTLS"
else
	fail "SMTP EHLO over STARTTLS failed"
fi
echo

echo "================================================="
echo " SMTP AUTH advertisement"
echo "================================================="
if echo "$SMTP_EHLO" | grep -qi "AUTH"; then
	echo "‚úÖ AUTH advertised"
	echo "$SMTP_EHLO" | grep -i "AUTH" || true
else
	fail "AUTH not advertised in EHLO response (clients may not be able to authenticate)"
fi
echo

echo "================================================="
echo " SMTP banner test (port 25)"
echo "================================================="
BANNER="$(timeout 5 nc -w 3 "${HOST}" 25 | head -n1 || true)"
if [[ -n "$BANNER" ]]; then
	echo "$BANNER"
else
	fail "No SMTP banner on port 25"
fi
echo

echo "================================================="
echo " SMTP PIPELINING support"
echo "================================================="
if echo "$SMTP_EHLO" | grep -qi "PIPELINING"; then
	echo "‚úÖ PIPELINING supported"
else
	warn "PIPELINING not advertised"
fi
echo

echo "================================================="
echo " SMTP SIZE limit check"
echo "================================================="
SIZE_LINE="$(echo "$SMTP_EHLO" | grep -i "SIZE" | head -n1 || true)"
if [[ -n "$SIZE_LINE" ]]; then
	echo "$SIZE_LINE"
	SIZE_BYTES="$(echo "$SIZE_LINE" | grep -oE '[0-9]+' | head -1 || true)"
	if [[ -n "$SIZE_BYTES" ]]; then
		SIZE_MB=$((SIZE_BYTES / 1048576))
		echo "‚úÖ Max message size: ${SIZE_MB} MB"
	else
		echo "‚úÖ SIZE advertised (no explicit limit found)"
	fi
else
	warn "SIZE not current advertised"
fi
echo

echo "================================================="
echo " SMTP 8BITMIME support"
echo "================================================="
if echo "$SMTP_EHLO" | grep -qi "8BITMIME"; then
	echo "‚úÖ 8BITMIME supported"
else
	warn "8BITMIME not advertised"
fi
echo

echo "================================================="
echo " SMTP DSN support"
echo "================================================="
if echo "$SMTP_EHLO" | grep -qi "DSN"; then
	echo "‚úÖ DSN supported"
else
	warn "DSN not advertised"
fi
echo

#############################################
# Swaks tests (only if installed)
#############################################

if [[ "$HAS_SWAKS" -eq 1 ]]; then
	echo "================================================="
	echo " SMTP AUTH LOGIN test (authentication only, no mail sent)"
	echo "================================================="
	swaks \
		--server "${HOST}" \
		--port "${SMTP_PORT}" \
		--auth LOGIN \
		--auth-user "${EMAIL}" \
		--auth-password "${PASS}" \
		--tls \
		--quit-after AUTH \
		--no-data >/dev/null 2>&1 && echo "‚úÖ SMTP AUTH succeeded" || fail "SMTP AUTH failed"
	echo

	echo "================================================="
	echo " SMTP send test email (to self)"
	echo "================================================="
	swaks \
		--server "${HOST}" \
		--port "${SMTP_PORT}" \
		--auth LOGIN \
		--auth-user "${EMAIL}" \
		--auth-password "${PASS}" \
		--tls \
		--from "${EMAIL}" \
		--to "${EMAIL}" \
		--header "Subject: ${TEST_SUBJECT}" \
		--body "Mail system test message: ${TEST_SUBJECT}" >/dev/null 2>&1 \
		&& echo "‚úÖ Test email sent successfully" \
		|| fail "Failed to send test email via SMTP"
	echo
else
	warn "Skipping swaks tests (swaks not installed)."
	echo
fi

#############################################
# Certificate expiration check (SMTP STARTTLS)
#############################################

echo "================================================="
echo " Certificate expiration check"
echo "================================================="
CERT_EXPIRY="$(
	echo | openssl s_client -connect "${HOST}:${SMTP_PORT}" -servername "${HOST}" -starttls smtp 2>/dev/null \
	| openssl x509 -noout -enddate 2>/dev/null \
	| cut -d= -f2 || true
)"
if [[ -n "$CERT_EXPIRY" ]]; then
	echo "Certificate expires: $CERT_EXPIRY"
	EXPIRY_EPOCH="$(date -d "$CERT_EXPIRY" +%s 2>/dev/null || true)"
	if [[ -n "${EXPIRY_EPOCH:-}" ]]; then
		NOW_EPOCH="$(date +%s)"
		DAYS_LEFT=$(((EXPIRY_EPOCH - NOW_EPOCH) / 86400))
		echo "Days until expiration: $DAYS_LEFT"
		if [[ "$DAYS_LEFT" -lt 0 ]]; then
			fail "Certificate appears expired"
		elif [[ "$DAYS_LEFT" -lt 30 ]]; then
			fail "Certificate expires in less than 30 days"
		elif [[ "$DAYS_LEFT" -lt 60 ]]; then
			warn "Certificate expires in less than 60 days"
		else
			echo "‚úÖ Certificate expiration OK"
		fi
	else
		warn "Could not parse expiration date into epoch (date -d failed)"
	fi
else
	fail "Could not determine certificate expiration"
fi
echo

#############################################
# Certificate hostname verification
#############################################

echo "================================================="
echo " Certificate hostname verification"
echo "================================================="
CERT_SANS="$(
	echo | openssl s_client -connect "${HOST}:${SMTP_PORT}" -servername "${HOST}" -starttls smtp 2>/dev/null \
	| openssl x509 -noout -text 2>/dev/null \
	| awk '/Subject Alternative Name/{flag=1;next}/X509v3/{flag=0}flag' \
	| tr -d '\n' || true
)"
if [[ -n "$CERT_SANS" ]]; then
	echo "Certificate SANs: $CERT_SANS"
	if echo "$CERT_SANS" | grep -qi "$HOST"; then
		echo "‚úÖ Certificate matches hostname"
	else
		fail "Certificate SANs do not include hostname: $HOST"
	fi
else
	warn "Could not extract SANs from certificate"
fi
echo

#############################################
# TLS downgrade tests (SMTP)
#############################################

echo "================================================="
echo " TLS 1.0 capability test"
echo "================================================="
if timeout 5 openssl s_client \
	-starttls smtp \
	-tls1 \
	-connect "${HOST}:587" \
	-servername "${HOST}" < /dev/null 2>&1 \
| grep -qi "Protocol  *: TLSv1"; then
	echo "TLS 1.0 supported"
else
	echo "TLS 1.0 not supported"
fi
echo

echo "================================================="
echo " TLS 1.1 capability test"
echo "================================================="
if timeout 5 openssl s_client \
	-starttls smtp \
	-tls1_1 \
	-connect "${HOST}:587" \
	-servername "${HOST}" < /dev/null 2>&1 \
| grep -qi "Protocol  *: TLSv1.1"; then
	echo "TLS 1.1 supported"
else
	echo "TLS 1.1 not supported"
fi
echo

echo "================================================="
echo " TLS acceptance test (TLS 1.2+)"
echo "================================================="
if timeout 5 openssl s_client \
	-starttls smtp \
	-tls1_2 \
	-connect "${HOST}:${SMTP_PORT}" \
	-servername "${HOST}" < /dev/null 2>&1 \
| grep -Eqi "Protocol *: TLSv1\.(2|3)"; then
	echo "‚úÖ OK (Modern TLS accepted)"
else
	fail "TLS1.2 handshake failed"
fi
echo

echo "================================================="
echo " TLS 1.3 support test"
echo "================================================="
if timeout 5 openssl s_client \
	-starttls smtp \
	-tls1_3 \
	-connect "${HOST}:${SMTP_PORT}" \
	-servername "${HOST}" < /dev/null 2>&1 \
| grep -qiE "Protocol *: TLSv1\.3"; then
	echo "‚úÖ TLS 1.3 supported (optimal)"
else
	echo "TLS 1.3 not supported (TLS 1.2 is acceptable)"
fi
echo

#############################################
# Summary & exit code (pipeline-friendly)
#############################################

echo "================================================="
echo " Summary"
echo "================================================="
if [[ "$FAIL_COUNT" -eq 0 ]]; then
	echo "‚úÖ All critical checks passed"
	echo "========================================"
	echo " Diagnostic completed successfully"
	echo "========================================"
	exit 0
else
	echo "‚ùå Critical failures: $FAIL_COUNT"
	echo "========================================"
	echo " Diagnostic completed with errors"
	echo "========================================"
	exit 1
fi
